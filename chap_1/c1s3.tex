\section{相对概形}\index{相对!概形}
\subsection{纤维积} \label{s:1.3.1}

这里有一个用概形的纤维积描述的，集合关于函数的原像思想的重要拓展。为了准备这个定义，我们首先复习集合范畴的情况。

两个集合$X$和$Y$在第三个集合$S$上的纤维积，在已知一个映射的图
\[
	\xymatrix{
	&X\ar[d]^\varphi\\
	Y\ar[r]_\psi &S
	}
\]
下，被定义为
\[
	X\times_S Y=\{(x,y)\in X\times Y\,:\,\varphi x=\psi y\}.
\]
纤维积有时候被叫做$X$（或者关于$X\to S$）到$Y$的\textit{拉回}\index{拉回}。这个构造非常有用地拓展了许多基础构造：

如果$S$是一个点，则它给出了一般的直积。

如果$X$和$Y$都是$S$的子集，而$\varphi$和$\psi$都是含入映射，则它给出交。

如果$Y\subset S$以及$\psi$是含入，他给出了$Y$在$X$中的原像。

如果$X=Y$，他给出了使得$\varphi$, $\psi$相等的集合，即映射的\textit{等值子}。

\begin{exe}
	验证这些断言！
\end{exe}

注意到，$X\times_S Y$与它到$X$和$Y$自然的投射给出了交换图
\[
	\xymatrix{
	X\times_S Y\ar[r]\ar[d]&X\ar[d]^\varphi\\
	Y\ar[r]_\psi &S
	}
\]
实际上，集合$X\times_S Y$能被下面的泛性质所确定：在所有使得下图交换的$Z$与给定的映射下
\[
	\xymatrix{
	Z\ar[r]\ar[d]&X\ar[d]^\varphi\\
	Y\ar[r]_\psi &S
	}
\]
$X\times_S Y$与投射是唯一的“最有效的”选择，意即，给定上图中的$Z$，存在唯一的映射$Z\to X\times_S Y$使得图
\[
	\xymatrix{
	Z\ar[dr]\ar[ddr]\ar[drr] & &\\
	& X\times_S Y \ar[r]\ar[d] &  X \ar[d]^\varphi\\
	& Y\ar[r]^\psi &  S
	}
\]
交换。

在概形范畴中，我们就\textit{定义}纤维积是一个满足上面泛性质的概形，特别地，泛性质保证了这个概形连同他到$X$和$Y$的投射是唯一的。于是我们能用纤维积来定义直积、交、原像以及等值子！但这就有一个问题，作为纤维积的这些对象是否在概形范畴是存在的？答案是是的，我们下面将描述它的构造。

首先，我们处理仿射情形。回忆仿射概形范畴与交换环范畴对偶，见Corollary \ref{coro:1.41}. 因此，如果我们有概形
\[
	X=\spec A,\quad Y=\spec B,\quad S=\spec R,
\]
其中$X$, $Y$映到$S$（因此$A$和$B$是$R$\hyp 代数），我们必须定义纤维积$X\times_S Y$为
\[
	X\times_S Y=\spec(A\otimes_R B).
\]
这是因为自然的图
\[
	\xymatrix{
	A\otimes_R B&A\ar[l]\\
	B\ar[u]&R\ar[l]\ar[u]_\varphi
	}
\]
有着与纤维积相反的泛性质。时髦一点说法即，张量积即一个交换环范畴的\textit{纤维余积}或者\textit{纤维直和}。

为了检查这个定义是合理的，可以注意到当$Y$是$S$的由$I$定义的闭子概形，即$B=R/I$时，我们有$A\otimes_R B=A/IA$. 于是$X\times_S Y=\spec A/IA$，这就是以前定义过的$Y$在$X$中的原像。

\begin{exe}\label{exe:1.46}
一些简单的特殊例子将在计算纤维积的时候给出巨大的帮助。直接通过代数的张量积的泛性质证明下面的事实：

\begin{compactenum}[(a)]
\item 对任意的$R$\hyp 代数$S$，我们有$R\otimes_R S=S$.
\item 若$S$, $T$是$R$\hyp 代数，$I\subset S$是一个理想，于是
\[
	(S/I)\otimes_R T=(S\otimes_R T)/(I\otimes 1)(S\otimes_R T).
\]
\item 如果$x_1$, $\dots$, $x_n$, $y_1$, $\dots$, $y_m$是不定元，于是
\[
	R[\text{$x_1$, $\dots$, $x_n$}]\otimes_R R[\text{$y_1$, $\dots$, $y_m$}]=R[\text{$x_1$, $\dots$, $x_n$, $y_1$, $\dots$, $y_m$}].
\]
\end{compactenum}
用这些原理来解决习题的剩余部分。
\begin{compactenum}[(a)] \setcounter{enumi}{3}
\item 令$m$, $n$是整数。计算纤维积
\[
	\spec \zz/(m)\times_{\spec \zz} \spec \zz/(n).
\]
\item 计算纤维积$\spec \cc \times_{\spec \rr} \spec \cc$.
\item 证明，对$R$上的任意多项式环$R[x]$和$R[y]$，我们有
\[
	\spec R[x]\times_{\spec R}\spec R[y]=\spec R[x,y].
\]
\end{compactenum}
注意在例子(d)中，纤维积的底空间是两个对应底空间的纤维积，但是这在(e)和(f)中并不正确。
\begin{compactenum}[(a)] \setcounter{enumi}{6}
\item 考虑环同态
\[
	R[x]\to R;\quad x\mapsto 0
\]
以及
\[
	R[x]\to R[y];\quad x\mapsto y^2.
\]
证明关于这些映射，我们有
\[
	\spec R[y]\times_{\spec R[x]}\spec R=\spec R[y]/(y^2).
\]
\end{compactenum}
\end{exe}

在一般的情况中，我们用仿射概形$\spec R_\rho$来覆盖$S$，以及将它们在$X$和$Y$中的原像用仿射概形$\spec A_{\rho\alpha}$和$\spec B_{\rho\beta}$来覆盖，于是我们可以说图
\[
	\xymatrix{
	&X\ar[d]^\varphi\\
	Y\ar[r]_\psi &S
	}
\]
被如下形式的图
\[
	\xymatrix{
	&\spec A_{\rho\alpha}\ar[d]^{\varphi_{\rho\alpha}}\\
	\spec B_{\rho\beta}\ar[r]_{\psi\beta} &\spec R_{\rho}
	}
\]
所覆盖。

当然，我们已经知道最后一幅图中的纤维积是$\spec(A_{\rho\alpha}\otimes_{R_\rho}B_{\rho\beta})$. 使用在上节末段提供的黏合思想，虽繁但不难验证这些概形在相交处相容，并且粘合起来就得到了所需的概形$X\times_S Y$，我们略去这些计算。纤维积的另一个构造方法将在第\ref{s:5.2.1}节中略加提到。

立刻，我们就可以用纤维积来给出在仿射概形$S$上的仿射空间$\bba_S^n$的另一种描述：

\begin{exe}\label{exe:1.47}
令$S$是任意概形。令$\bba_\zz^n=\spec \zz[x_1$, $\dots$, $x_n]$是在$\spec \zz$上的仿射空间，之前已经定义过它了（这个概形将在下一章详细描述）。证明，$S$上的仿射空间$\bba_S^n$能被描述为纤维积：$\bba_S^n=\bba_\zz^n\times_{\spec \zz} S$.
\end{exe}

我们同样能用纤维积来定义一个态射$\psi:Y\to X$在任意概形的任意点上的\textit{纤维}：如果$p$是一个$X$的点对应于$R$的素理想$\pp$，则$\psi$在点$p$处的纤维是$Y$与单点的概形$\spec \kappa(p)$的纤维积。当$X$和$Y$都是仿射概形时，记$Y=\spec T$以及$X=\spec R$，作为点集，我们有
\[
	\psi^{-1}(p)=\spec \kappa(p)\times_X Y=\spec (R_\pp /\pp_\pp \otimes_R T)=\spec (R_\pp/\pp_\pp \otimes_R T/\pp T).
\]
这是$T$中所有原像在$R$中等于$\pp$的素理想的集合。更一般地，定义一个$X$的闭子概形$X'$关于态射$\psi$的\textit{原像}或者称为\textit{逆像}为纤维积$X'\times_X Y$.

就像在上面处理的仿射情况中那样，$X'$的原像$\psi^{-1}X'$是一个$Y$的闭子概形。使用$\oo_Y$上的$\oo_X$-代数结构，原像的理想层可以写作$\mathscr{I}_{\psi^{-1} X'}=\mathscr{I}_{X'}\cdot \oo_Y$.

另一个使用纤维积的典型范例是在研究簇在基域扩张下的表现（某些人常常在某些上下文中称为“基变换”而不是纤维积）。我们将在下面的章节中看到这个背景中的不少例子，概形理论的这个概念为处理算术问题提供了足够的自由与便利。

就像Exercise \ref{exe:1.46}中的(b)和(c)，纤维积$X\times_S Y$的点集一般并\text{不}等于$X$和$Y$点集的（在集合范畴中的）纤维积。这并不是特别异常的，它不过是反应了如下事实：双变量函数$f(x,y)$的理论较之$g(x)h(y)$型的函数的理论要丰富得多。不管怎样，第 \ref{chap:6} 章的定义提供了一种视角来消解这种怪异。

\subsection{\texorpdfstring{$S$}{S}- 概形范畴}\label{s:1.3.2}

就像在集合范畴里面一样，我们能用纤维积得到绝对积，通过取$S$为概形范畴的终对象，终对象是一个概形$S$，每一个概形到$S$都有且只有一个态射。由Exercise \ref{exe:1.42}，概形范畴的终对象是$\spec \zz$. 然而，绝对积有着许多更加惊奇的性质。我们已经在Exercise \ref{exe:1.46}(d) 中看到，（当$m$和$n$互素时）两个非空集合的积可能是空的！概形的积同样还有其他奇怪的特性：比如，一个不可约概形的维度能被定义为其任意仿射开集的坐标环的Krull维度。我们可能希望两个概形的积
\[
	X\times Y=X\times_{\spec \zz} Y
\]
的维度是$X$和$Y$的维度的和。但实际上，我们有下题中的结论。

\begin{exe}\label{exe:1.48}
证明，如果$X=\spec \zz[x]$以及$Y=\spec \zz[y]$，那么
\[
	\dim X\times Y=\dim X+\dim Y-\dim \spec \zz=\dim X+\dim Y-1.
\]
\end{exe}

这种奇怪和许多其他可能的事情，可以简单但方便地拓展我们的定义来消除：我们经常希望工作在一个给定域（或环）$K$\text{上的概形}，或者称为$K$-概形。当然，我们下面用的态射都将与这个结构相容。非正式地说，这就意味着我们考虑的是$X$连同$\oo_X(X)$上的$K$-代数结构，还有那些与这些结构相容的态射。这在范畴中，$\spec K$是终对象，所以积就是$\spec K$上的纤维积。如果$K$是一个域，则$K$-概形范畴的积
表现得更符合基本的几何直觉。比方说：

\begin{exe}\label{exe:1.49}
令$K$是一个域。如果$X$和$Y$是非空$K$\hyp 概形，于是在$K$\hyp 概形范畴，积$X\times Y=X\times_{\spec K}Y$是非空的。
\end{exe}

此外，此时$\spec K$的维度为$0$，大家可以检查，对有限生成$K$-代数的谱的概形，几个对象的积的维度等于各个对象的维度的和，如所应是。

为了容纳概形族，我们将这个概念拓展得更远一些。一个$\oo_X(X)$上的$K$-代数构造不过是一个环同态$K\to \oo_X(X)$，那么从Theorem \ref{thm:1.40}，他等价于给出映射$X\to \spec K$. 将$\spec K$换成任意概形，我们就定义了$S$\textit{上的概形}，或者称为$S$-\textit{概形}，是一个概形$X$连同一个态射$X\to S$. 我们可以没那么严谨地将$S$上的概形想象为一族“由$S$中的点参数化的”概形，即对每一个$S$上的点，我们都有该点处的纤维。一个~\textit{$S$上的概形的态射}（或称为~\textit{$S$-态射}）是一个交换图
\[
	\xymatrix{
	X\ar[rr]\ar[rd]&&Y\ar[ld]\\
	&S&
	}
\]
如果$X$和$Y$都是$S$上的概形，我们记$\Mor_S(X,Y)$是$S$-态射的集合。注意到，$S$上的纤维积$X\times_S Y$就是$S$-概形范畴的积。

按照习惯，如果$S=\spec R$是仿射概形，我们会用“$R$-概形”以及“$R$-概形范畴”来代替“$S$-概形”和“$S$-概形范畴”。

引入$S$-概形范畴看上去又增加了一层复杂性，但实际上更多时候它是移去了一层复杂性。比方说，如果想用概形语言做经典的复数域上的代数几何，我们就要在$\cc$-概形范畴中工作。为看到确实如此，注意到，在任意合理的意义下，点$\spec \cc$都没有非平凡的自同构，以及概形$\spec \cc[x]/(x^2+1)$包含了一对点有着自同构群$\zz/(2)$. 事实上，这只是在$\cc$-概形上的情况。而在任意概形的范畴，点$\spec \cc$的自同构群就很大的了：它是$\cc$在$\mathbb Q$上的Galois群，而$\spec \cc[x]/(x^2+1)$的自同构群就变得更糟了。于是，在$\cc$-概形范畴工作移去了（可能是不想要的）多余的Galois群$\mathrm{Gal}(\cc/\mathbb Q)$结构。

\begin{exe}\label{exe:1.50}
在$\cc$上的概形范畴，找到Exercise \ref{exe:1.20}中概形$X_1$和$X_3$的自同构群。
\end{exe}

\subsection{整体\texorpdfstring{$\spec$}{Spec}} \label{s:1.3.3}

如果$S=\spec R$是一个仿射概形，一个仿射$S$-概形不过是一个$R$-代数的谱。我们现在将拓展这个构造来描述$S$-概形范畴中的类似物，其中$S$是一个任意概形。

首先，对任意概形$S$，我们定义\textit{拟凝聚$\oo_S$-代数层}。可以预想到，这是一个$\oo_S$-代数层$\mathscr F$，对每一个仿射开集$U=\spec R\subset S$以及一个基本开集$U'=\spec R_f\subset U$，作为$R=\oo_S(U)$-代数，我们有
\[
	\mathscr F(U')=\mathscr F(U)\otimes_R \oo_S(U')=\mathscr F(U)\otimes_R R_f.
\]
接着，我们对概形$S$上的任意拟凝聚$\oo_S$-代数层$\mathscr F$给出一个概形$X=\spec \mathscr F$以及一个结构态射$X\to S$，使得当$S=\spec R$是仿射概形的时候，我们会得到$X=\spec \mathscr F(S)$，而结构态射$X\to S$将由$\mathscr F(S)$上的$R=\oo_S(S)$-代数结构诱导出来。

有很多方式来实现这个，一种是直接再用一次黏合构造：我们用仿射开集$U_\alpha=\spec R_\alpha$来覆盖$S$，定义$X$是概形$\spec \mathscr F(U_\alpha)$的并，黏合映射由限制映射$\mathscr F(U_\alpha)\to \mathscr F(U_\alpha\cap U_\beta)$诱导出来。这是可行的，但验证黏合出来的$\spec \mathscr F$与选取的覆盖无关也是一件麻烦的事情，更甚者，描述$\spec \mathscr F$的点集并不方便。我们这里将给出另一个构造。

从一个定义开始：对给定的拟凝聚$\oo_S$-代数层$\mathscr F$，我们定义$\mathscr F$中的一个\textit{素理想层}为一个拟凝聚理想层$\mathscr I \subsetneq \mathscr F$，使得对每一个仿射开集$U\subset S$，理想$\mathscr I(U)\subset \mathscr F(U)$或者是素理想或者是单位理想。（观察对任意的仿射概形$X$，$X$的点就是$\oo_X$上的素理想层。）现在，我们将分三步定义$X=\spec \mathscr F$，就像我们对环的谱做的那样。首先，作为集合，$X$是$\mathscr F$中的素理想层的集合。其次，作为拓扑空间：对任意开集$U\subset S$（不一定是仿射的）以及截面$\sigma \in \mathscr F(U)$，令$V_{U,\sigma}\subset X$是满足$\sigma\not\in \mathscr P(U)$的素理想层$\mathscr P \subset \mathscr F$的集合，将它们取作拓扑基。最后，我们定义基本开集上的结构层$\oo_X$通过置
\[
	\oo_X(V_{U,\sigma})=\mathscr F(U)[\sigma^{-1}].
\]
对态射$f:X\to S$：作为映射，它将素理想层$\mathscr P\subset \mathscr F$变成其在$\oo_S\to \mathscr F$下的原像；此外，以及函数间的拉回映射
\[
	f^\#:\oo_S(U)\to \oo_X(f^{-1}(U))=\mathscr F(U)
\]
就是$U$上的结构映射$\oo_S\to \mathscr F$.

\begin{exe}\label{exe:1.51}
证明仿射概形$X$的点一一对应于$\oo_X$的素理想层。
\end{exe}

\begin{exe}\label{exe:1.52}
证明，如果$f:Y\to X$是一个态射，而$\mathscr P$是一个$\oo_Y$的素理想层，于是$f_*(\mathscr P)$是一个$f_*\oo_Y$的素理想层。
\end{exe}

\begin{exe}\label{exe:1.53}
证明，如果$f:Y\to X$是一个态射，则$f$对应的集合间映射将$\mathscr P\subset \oo_Y$映到$(f^\#)^{-1}(f_*(\mathscr P))\subset \oo_X$.
\end{exe}

整体$\spec$最简单的例子是任意概形$S$上的仿射空间的另一种构造：

\begin{exe}\label{exe:1.54}
令$S$是任意概形。证明$S$上的仿射空间$\mathbb A^n_S$可以由整体$\spec$来构造：
\[
	\mathbb A^n_S=\spec \left(\mathrm{Sym}(\oo_S^{\oplus n})\right).
\]
\end{exe}